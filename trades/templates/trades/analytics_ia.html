{% extends "base.html" %}

{% block content %}
{% load trades_tags %}
<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;margin-bottom:0.5rem;">
  <h1 style="margin:0;">Analytics avan√ßado por IA</h1>
  <div style="font-size:13px;color:#cbd5e1;opacity:.9;">Premium / Premium+. Limite: 1 an√°lise por semana.</div>
</div>

{% if not ai_can_request and ai_next_available %}
<div style="margin-bottom:1rem; padding:12px 16px; border-radius:8px; background:rgba(254,243,199,0.15); border:1px solid rgba(254,243,199,0.4); color:#e2e8f0;">
  <strong>Sua pr√≥xima an√°lise poder√° ser realizada em:</strong> {{ ai_next_available|date:"d/m/Y" }} √†s {{ ai_next_available|time:"H:i" }}.
  {% if not ai_has_new_trades %}
  <br><span style="color:#fcd34d;">Registre pelo menos um novo trade desde a √∫ltima an√°lise para solicitar uma nova.</span>
  {% endif %}
</div>
{% endif %}

<div style="margin-bottom:1.5rem; padding:14px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.04);">
  <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;">
    <div style="color:#e2e8f0;">
      <div style="font-weight:800; letter-spacing:.04em;">Solicitar an√°lise</div>
      <div style="color:#cbd5e1; font-size:13px;">As m√©tricas s√£o pr√©-calculadas; a IA responde apenas a perguntas espec√≠ficas para otimizar uso de tokens. S√≥ √© poss√≠vel nova an√°lise ap√≥s 7 dias da √∫ltima e se houver novos trades registrados.</div>
    </div>
    <div>
      {% if ai_can_request %}
        <form method="post" action="{% url 'trades:analytics_ia' %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary" style="padding:10px 14px; font-size:12px;">Solicitar an√°lise por IA</button>
        </form>
      {% else %}
        {% if ai_last_run %}
          <p style="margin:0; color:#cbd5e1; font-size:13px;">Abaixo est√° sua <strong>√∫ltima an√°lise</strong>. Quando puder solicitar uma nova, o bot√£o aparecer√° aqui.</p>
          <p style="margin:0.25rem 0 0; color:#94a3b8; font-size:12px;">√öltima an√°lise: {{ ai_last_run.requested_at|date:"d/m/Y H:i" }}</p>
        {% else %}
          <p style="margin:0; color:#cbd5e1; font-size:13px;">Aguarde a data acima ou registre novos trades para solicitar uma nova an√°lise.</p>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

{% if ai_requested %}
<div style="margin-bottom:1.5rem; padding:12px 16px; border-radius:8px; background:rgba(56,189,248,0.15); border:1px solid rgba(56,189,248,0.4); color:#e2e8f0;">
  An√°lise solicitada. O resultado ser√° exibido abaixo quando estiver pronto.
</div>
{% endif %}

<section style="margin-bottom:2rem;">
  <h2>Trades por ganho (decrescente)</h2>
  <p style="color:#cbd5e1; font-size:13px;">Tabela ordenada por resultado (maior ganho primeiro). Ganho/CT = ganho por contrato (Forex: por lote 0,01).</p>
  {% if analytics_trades_page %}
  <div style="overflow-x:auto; margin-top:1rem;">
    <table style="width:100%;border-collapse:collapse;table-layout:fixed;font-size:12px;">
      <thead>
        <tr>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Data</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">S√≠mbolo</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Mercado</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Dire√ß√£o</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Setup</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Entrada</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">HTF</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Regi√£o HTF</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Tend√™ncia</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Painel SMC</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Gatilho</th>
          <th style="text-align:left;padding:0.4rem;border-bottom:1px solid #334155;">Parcial</th>
          <th style="text-align:right;padding:0.4rem;border-bottom:1px solid #334155;">Resultado</th>
          <th style="text-align:right;padding:0.4rem;border-bottom:1px solid #334155;">Ganho/CT</th>
          <th style="text-align:center;padding:0.4rem;border-bottom:1px solid #334155;">Captura</th>
        </tr>
      </thead>
      <tbody>
        {% for trade in analytics_trades_page %}
        <tr>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">
            <a href="{% url 'trades:trade_edit' trade.pk %}?next={{ request.get_full_path|urlencode }}" style="color:#38bdf8;">{{ trade.executed_at|date:"d/m/Y H:i" }}</a>
          </td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.symbol }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_market_display }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_direction_display }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_setup_display }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_entry_type_display }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_high_time_frame_display }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_region_htf_display }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_trend_display }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_smc_panel_display }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_trigger_display }}</td>
          <td style="padding:0.4rem;border-bottom:1px solid #1e293b;">{{ trade.get_partial_trade_display }}</td>
          <td style="padding:0.4rem;text-align:right;border-bottom:1px solid #1e293b;">R$ {{ trade.profit_amount }}</td>
          <td style="padding:0.4rem;text-align:right;border-bottom:1px solid #1e293b;">R$ {{ trade.ganho_ct|floatformat:2 }}</td>
          <td style="padding:0.4rem;text-align:center;border-bottom:1px solid #1e293b;">{% if trade.screenshot %}<a href="{% url 'trades:trade_screenshot' trade.pk %}" target="_blank" style="color:#38bdf8;">üì∑</a>{% else %}‚Äî{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div style="margin-top:1rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
    <div>Mostrando {{ analytics_trades_page.start_index }}‚Äì{{ analytics_trades_page.end_index }} de {{ analytics_trades_page.paginator.count }} trades</div>
    {% if analytics_trades_page.has_other_pages %}
    <nav style="display:flex;gap:0.5rem;align-items:center;">
      {% if analytics_trades_page.has_previous %}<a href="?analytics_page={{ analytics_trades_page.previous_page_number }}" style="color:#38bdf8;">Anterior</a>{% endif %}
      {% for num in analytics_trades_page.paginator.page_range %}{% if num == analytics_trades_page.number %}<span style="font-weight:bold;">{{ num }}</span>{% else %}<a href="?analytics_page={{ num }}" style="color:#38bdf8;">{{ num }}</a>{% endif %}{% endfor %}
      {% if analytics_trades_page.has_next %}<a href="?analytics_page={{ analytics_trades_page.next_page_number }}" style="color:#38bdf8;">Pr√≥xima</a>{% endif %}
    </nav>
    {% endif %}
  </div>
  {% else %}
  <p style="color:#94a3b8;">Nenhum trade registrado.</p>
  {% endif %}
</section>

<section style="margin-bottom:2rem;">
  <h2>Top 3 combina√ß√µes que mais geram ganho</h2>
  <p style="color:#cbd5e1; font-size:13px;">Mesmo Setup, Entrada, HTF, Regi√£o HTF, Tend√™ncia, Painel SMC, Gatilho e Parcial.</p>
  {% if top3_best_combos %}
  <div style="overflow-x:auto;">
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Setup</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Entrada</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">HTF</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Regi√£o HTF</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Tend√™ncia</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Painel SMC</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Gatilho</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Parcial</th>
          <th style="text-align:right;padding:0.5rem;border-bottom:1px solid #334155;">Resultado</th>
        </tr>
      </thead>
      <tbody>
        {% for row in top3_best_combos %}
        <tr>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.setup }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.entry_type }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.high_time_frame }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.region_htf }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.trend }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.smc_panel }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.trigger }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.partial_trade }}</td>
          <td style="padding:0.5rem;text-align:right;border-bottom:1px solid #1e293b;">R$ {{ row.total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="color:#94a3b8;">Dados insuficientes para agrupar.</p>
  {% endif %}
</section>

<section style="margin-bottom:2rem;">
  <h2>Top 3 combina√ß√µes que mais geram perda</h2>
  <p style="color:#cbd5e1; font-size:13px;">Evite essas combina√ß√µes para melhorar seu resultado.</p>
  {% if top3_worst_combos %}
  <div style="overflow-x:auto;">
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Setup</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Entrada</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">HTF</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Regi√£o HTF</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Tend√™ncia</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Painel SMC</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Gatilho</th>
          <th style="text-align:left;padding:0.5rem;border-bottom:1px solid #334155;">Parcial</th>
          <th style="text-align:right;padding:0.5rem;border-bottom:1px solid #334155;">Resultado</th>
        </tr>
      </thead>
      <tbody>
        {% for row in top3_worst_combos %}
        <tr>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.setup }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.entry_type }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.high_time_frame }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.region_htf }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.trend }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.smc_panel }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.trigger }}</td>
          <td style="padding:0.5rem;border-bottom:1px solid #1e293b;">{{ row.labels.partial_trade }}</td>
          <td style="padding:0.5rem;text-align:right;border-bottom:1px solid #1e293b;">R$ {{ row.total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="color:#94a3b8;">Dados insuficientes.</p>
  {% endif %}
</section>

<section style="margin-bottom:2rem;">
  <h2>Impacto ao evitar as combina√ß√µes negativas</h2>
  <p style="color:#e2e8f0;">Se voc√™ parar de fazer as combina√ß√µes negativas acima, seu ganho ir√° melhorar em <strong>R$ {{ improvement_reais }}</strong>, e seu resultado acumulado seria <strong>R$ {{ improvement_new_total }}</strong>, o que representa uma melhora de <strong>{{ improvement_pct }}%</strong>.</p>
</section>

<section style="margin-bottom:2rem;">
  <h2>Resultado por hor√°rio</h2>
  <p style="color:#cbd5e1; font-size:13px;">Barras: verde = ganhos no hor√°rio, vermelha = perdas, azul = lucro l√≠quido.</p>
  <div style="max-width:800px; height:280px;"><canvas id="chart-by-hour" height="200"></canvas></div>
</section>

<section style="margin-bottom:2rem;">
  <h2>Resultado por s√≠mbolo (at√© 10)</h2>
  <p style="color:#cbd5e1; font-size:13px;">S√≠mbolos com mais trades. Verde = ganhos, vermelha = perdas, azul = lucro.</p>
  <div style="max-width:900px; height:320px;"><canvas id="chart-by-symbol" height="240"></canvas></div>
</section>

<section style="margin-bottom:2rem;">
  <h2>Resultado por mercado</h2>
  <p style="color:#cbd5e1; font-size:13px;">Cada gr√°fico: ganho (verde), perda (vermelho), lucro (azul).</p>
  <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:1.5rem;">
    {% for m in chart_market_data %}
    <div><p style="margin:0 0 0.5rem; font-size:13px; color:#cbd5e1;">{{ m.market_label }}</p><canvas id="chart-market-{{ forloop.counter0 }}" height="140"></canvas></div>
    {% endfor %}
  </div>
</section>

<section style="margin-bottom:2rem;">
  <h2>M√©tricas dispon√≠veis para an√°lise</h2>
  <p style="color:#cbd5e1; font-size:13px;">Resumo das m√©tricas j√° calculadas (sem uso de IA). A IA utilizar√° esses dados para responder apenas √†s perguntas definidas.</p>
  {% with adv=advanced %}
  <div style="display:flex;flex-wrap:wrap;gap:1rem;margin-top:1rem;">
    <div style="background:#1e293b;padding:1rem;border-radius:8px;flex:1;min-width:140px;">
      <strong>Total trades</strong>
      <div>{{ adv.total_trades }}</div>
    </div>
    <div style="background:#1e293b;padding:1rem;border-radius:8px;flex:1;min-width:140px;">
      <strong>Win rate</strong>
      <div>{{ adv.win_rate }}%</div>
    </div>
    <div style="background:#1e293b;padding:1rem;border-radius:8px;flex:1;min-width:140px;">
      <strong>Resultado acumulado</strong>
      <div>R$ {{ adv.total_profit }}</div>
    </div>
    <div style="background:#1e293b;padding:1rem;border-radius:8px;flex:1;min-width:140px;">
      <strong>Profit factor</strong>
      <div>{{ adv.profit_factor }}</div>
    </div>
    <div style="background:#1e293b;padding:1rem;border-radius:8px;flex:1;min-width:140px;">
      <strong>Payoff</strong>
      <div>{{ adv.payoff }}</div>
    </div>
    <div style="background:#1e293b;padding:1rem;border-radius:8px;flex:1;min-width:140px;">
      <strong>Max drawdown</strong>
      <div>R$ {{ adv.max_drawdown }} ({{ adv.max_drawdown_pct }}%)</div>
    </div>
  </div>
  {% endwith %}
</section>

<section style="margin-bottom:2rem;">
  <h2>Resposta da IA</h2>
  <div style="padding:1.5rem; border-radius:12px; border:1px solid #334155; background:rgba(15,23,42,0.6); color:#e2e8f0;">
    {% if ai_last_run and ai_last_run.result %}
      <div style="white-space:pre-wrap;">{{ ai_last_run.result|format_analytics_result }}</div>
      <p style="margin:1rem 0 0; color:#94a3b8; font-size:12px;">An√°lise de {{ ai_last_run.requested_at|date:"d/m/Y H:i" }}</p>
    {% else %}
      <p style="margin:0; color:#94a3b8;">Aqui ser√° exibida a an√°lise gerada pela IA. Solicite uma an√°lise quando o bot√£o estiver dispon√≠vel.</p>
    {% endif %}
  </div>
</section>

<p>
  <a href="{% url 'trades:dashboard_advanced' %}" style="color:#38bdf8;">‚Üê Voltar ao Dashboard Avan√ßado</a>
</p>

{{ chart_hour_data|json_script:"chart-hour-data" }}
{{ chart_symbol_data|json_script:"chart-symbol-data" }}
{{ chart_market_data|json_script:"chart-market-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const green = "#11734b";
  const red = "#b10202";
  const blue = "#38bdf8";

  // Gr√°fico por hor√°rio
  const hourEl = document.getElementById("chart-hour-data");
  if (hourEl && document.getElementById("chart-by-hour")) {
    const hourData = JSON.parse(hourEl.textContent);
    if (hourData.length) {
      new Chart(document.getElementById("chart-by-hour"), {
        type: "bar",
        data: {
          labels: hourData.map(function(d) { return d.label; }),
          datasets: [
            { label: "Ganho", data: hourData.map(function(d) { return d.gain; }), backgroundColor: green },
            { label: "Perda", data: hourData.map(function(d) { return Math.abs(d.loss); }), backgroundColor: red },
            { label: "Lucro", data: hourData.map(function(d) { return d.net; }), backgroundColor: blue }
          ]
        },
        options: {
          scales: {
            x: { stacked: false, ticks: { color: "#cbd5e1" }, grid: { display: false } },
            y: { stacked: false, ticks: { color: "#cbd5e1" }, grid: { color: "#1e293b" } }
          },
          plugins: { legend: { position: "bottom", labels: { color: "#cbd5e1" } }, tooltip: { enabled: false } }
        }
      });
    }
  }

  // Gr√°fico por s√≠mbolo (3 barras: ganho, perda, lucro)
  const symbolEl = document.getElementById("chart-symbol-data");
  if (symbolEl && document.getElementById("chart-by-symbol")) {
    const symbolData = JSON.parse(symbolEl.textContent);
    if (symbolData.length) {
      new Chart(document.getElementById("chart-by-symbol"), {
        type: "bar",
        data: {
          labels: symbolData.map(function(d) { return d.label; }),
          datasets: [
            { label: "Ganho", data: symbolData.map(function(d) { return d.gain; }), backgroundColor: green },
            { label: "Perda", data: symbolData.map(function(d) { return Math.abs(d.loss); }), backgroundColor: red },
            { label: "Lucro", data: symbolData.map(function(d) { return d.net; }), backgroundColor: blue }
          ]
        },
        options: {
          scales: {
            x: { stacked: false, ticks: { color: "#cbd5e1", maxRotation: 45 } },
            y: { stacked: false, ticks: { color: "#cbd5e1" }, grid: { color: "#1e293b" } }
          },
          plugins: { legend: { position: "bottom", labels: { color: "#cbd5e1" } }, tooltip: { enabled: false } }
        }
      });
    }
  }

  // Gr√°ficos donut por mercado: fatia ganho (verde), perda (vermelho)
  const marketEl = document.getElementById("chart-market-data");
  if (marketEl) {
    const marketData = JSON.parse(marketEl.textContent);
    marketData.forEach(function(m, i) {
      const canvas = document.getElementById("chart-market-" + i);
      if (!canvas) return;
      var total = m.gain + m.loss;
      var vals = total > 0 ? [m.gain, m.loss] : [1];
      var colors = total > 0 ? [green, red] : ["#334155"];
      new Chart(canvas, {
        type: "doughnut",
        data: {
          labels: ["Ganho", "Perda"],
          datasets: [{ data: vals, backgroundColor: colors }]
        },
        options: {
          plugins: { legend: { display: false }, tooltip: { enabled: false } }
        }
      });
    });
  }
});
</script>
{% endblock %}
